version: '3'

silent: true

env:
  HOST_USR:
    sh: whoami
  HOST_UID:
    sh: id -u
  HOST_GID:
    sh: id -g
  HOST_ID: '{{.HOST_UID}}:{{.HOST_GID}}'

  PROJECT_NAME:
    sh: basename "$PWD"

  DOCKER_NETWORK: '{{.PROJECT_NAME}}.network'

  ENV_ROOT_PATH:
    sh: realpath ./env
  INFRA_BASE_PATH:
    sh: realpath ./infra
  SRC_BASE_PATH:
    sh: realpath ./src
  INFRA_DOCKER_PATH:
    sh: realpath ./infra/docker


dotenv: ['{{.ENV_ROOT_PATH}}/project.env']


includes:
  dust:
    taskfile: ./Taskfile.dust.yaml


tasks:

  default:
    summary: |
      Available Task list.
    cmds:
      - task --list

  ## Infrastructure
  ##################

  infra-up:
    desc: Start infrastructure services.
    cmds:
      - '{{.DOCKER_COMPOSE}} up -d --remove-orphans --build'
      - '{{.EXEC_LOG}} DONE "Infrastructure is up and running."'

  infra-stop:
    desc: Stop infrastructure services.
    cmds:
      - '{{.DOCKER_COMPOSE}} stop'
      - '{{.EXEC_LOG}} DONE "Infrastructure has been stopped."'

  infra-restart:
    desc: Restart infrastructure services.
    cmds:
      - task: infra-stop
      - task: infra-up

  infra-init:
    desc: "Start services and initialize environment."
    summary: |
      WARNING: requires `host-init` to have been run first.
    cmds:
      - mkdir -p "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/pgsql"
      - mkdir -p "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/redis"
      - mkdir -p "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/elasticsearch"
      - mkdir -p "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/qdrant"
      - mkdir -p "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/backend-home"
      - task: infra-up
      - task: dust:init
      - '{{.EXEC_LOG}} DONE "Environment initialized."'

  infra-clean:
    desc: Reset infrastructure and remove persistent data.
    cmds:
      - task: dust:clean
      - sudo rm -rf "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/pgsql"
      - sudo rm -rf "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/redis"
      - sudo rm -rf "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/elasticsearch"
      - sudo rm -rf "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/qdrant"
      - sudo rm -rf "{{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data/backend-home"
      - '{{.EXEC_LOG}} DONE "Persistent infrastructure data has been cleaned."'

  infra-reset:
    desc: Fully reset infrastructure to a clean install.
    cmds:
      - task: infra-clean
      - task: infra-init

  infra-ps:
    desc: List running infrastructure services.
    cmds:
      - '{{.DOCKER_COMPOSE}} ps'


  ## Environment
  ###############

  env-config-edit:
    desc: "Open local env config files in editor."
    cmds:
      - $EDITOR {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/*.env

  env-config-prepare:
    desc: "Initialize local environment configuration from default or local templates."
    cmds:
      - |
        echo -e "\nWhich template to copy? (default / local) [default]: "
        read -r TEMPLATE_ENV
        TEMPLATE_ENV=${TEMPLATE_ENV:-default}
        TEMPLATE_PATH={{.INFRA_BASE_PATH}}/configuration/$TEMPLATE_ENV
        echo -e "\nCopying from $TEMPLATE_PATH to {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}..."
        mkdir -p {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/data
        cp -r "$TEMPLATE_PATH"/* {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/
        {{.EXEC_LOG}} DONE "Environment configuration prepared from $TEMPLATE_ENV template."

  env-backup:
    desc: "Backup the current environment state."
    cmds:
      - |
        echo "Backing up environment '{{.DEPLOY_ENV}}'..."
        SRC={{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}
        DEST={{.ENV_ROOT_PATH}}/backup/{{.DEPLOY_ENV}}
        if [ -d "$SRC" ]; then \
          mkdir -p "$DEST" && \
          cp -r "$SRC"/* "$DEST" && \
          {{.EXEC_LOG}} DONE "Backup completed." ; \
        else \
          {{.EXEC_LOG}} ERROR "No environment found to backup: $SRC" ; \
        fi

  env-restore:
    desc: "Restore environment from backup."
    cmds:
      - |
        echo "Restoring environment '{{.DEPLOY_ENV}}' from backup..."
        rm -rf {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}
        mkdir -p {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}
        cp -r {{.ENV_ROOT_PATH}}/backup/{{.DEPLOY_ENV}}/* {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}/
        {{.EXEC_LOG}} DONE "Environment restored from backup."

  env-clean:
    desc: "Delete current environment data and config."
    cmds:
      - echo "Deleting {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}"
      - rm -rf {{.ENV_ROOT_PATH}}/{{.DEPLOY_ENV}}
      - '{{.EXEC_LOG}} DONE "Environment folder removed."'


  ## Host
  #########################

  host-clean:
    desc: "WARNING: Clean host (containers, volumes, networks)."
    cmds:
      - docker ps -aq | xargs -r docker stop
      - docker ps -aq | xargs -r docker rm -v
      - docker volume ls -q | xargs -r docker volume rm
      - docker network ls -q --filter type=custom | xargs -r docker network rm
      - '{{.EXEC_LOG}} DONE "Host cleaned (containers, volumes, networks)."'
    silent: false

  host-reset:
    desc: "WARNING: Reset host (containers, images, builders, system)."
    cmds:
      - task: host-clean
      - docker images -aq | xargs -r docker rmi -f
      - docker builder prune -f
      - docker system prune -a -f
      - '{{.EXEC_LOG}} DONE "Host reset complete."'
    silent: false

  host-init:
    desc: "Initialize host setup (submodules, configs)."
    cmds:
      - git submodule update --init --recursive
      - '{{.EXEC_LOG}} DONE "Git submodules initialized."'


  ## Diagnostic
  #########################

  log-host.env:
    desc: Log host environment.
    summary: |
      WARNING: May print sensitive variables. Use in development only.
    cmds:
      - printenv | sort

  log-host.system:
    desc: Log system diagnostics.
    cmds:
      - docker info
      - df -h
      - docker system df

  log-infra:
    desc: Show infrastructure logs.
    cmds:
      - '{{.DOCKER_COMPOSE}} logs -f --tail=100'
